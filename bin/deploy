#!/bin/sh
#
# deploy:
# Update installation of NotApathetic from CVS.
#
# Copyright (c) 2005 UK Citizens Online Democracy. All rights reserved.
# Email: francis@mysociety.org; WWW: http://www.mysociety.org/
#
# $Id: deploy,v 1.1 2005-04-05 15:33:54 francis Exp $
#

set -e

# Check who and where we are, and include useful functions
NA_BIN=`pwd`
MYSOCIETY_BIN=$NA_BIN/../../bin
SCRIPT_COMMAND=pb/bin/deploy
. ../../shlib/deployfns
check_who_where very.unfortu.net root

# Which virtual server to update
NA_VHOST=$1
[ x$NA_VHOST = x ] && die "specify target vhost directory as single argument"
[ ! -d $NA_VHOST ] && die "specify target vhost directory as single argument"

# NotApathetic
NA_NAME="NotApathetic.com"
NA_UNAME=na
NA_DEPLOYSPACE=$NA_VHOST/deployspace
hostname=$( echo $NA_VHOST | sed 's@/$@@' | sed 's@^.*/@@' )
NA_DB_UNIX_USER=na

# Main body of script
fmt << END
This will update $hostname from CVS and gracefully restart 
Apache.  

Press RETURN to continue.
END
read DUMMY

warn "Exporting from CVS..."
cvs_export $NA_UNAME $NA_VHOST $NA_DEPLOYSPACE

warn "Stopping services..."
down_notice $NA_VHOST $NA_NAME

warn "Rsyncing new data files..."
rsync_across $NA_DEPLOYSPACE $NA_VHOST

warn "Starting services..."
apachectl graceful
up_notice $NA_VHOST

